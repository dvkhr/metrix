package handlers // import "github.com/dvkhr/metrix.git/internal/handlers"


FUNCTIONS

func CheckImplementations()
func ReadAndUnmarshal(req *http.Request, v interface{}) error

TYPES

type MetricStorage interface {
	Save(ctx context.Context, mt service.Metrics) error
	SaveAll(ctx context.Context, mt *[]service.Metrics) error
	Get(ctx context.Context, metricName string) (*service.Metrics, error)
	List(ctx context.Context) (*map[string]service.Metrics, error)
	ListSlice(ctx context.Context) ([]service.Metrics, error)
	NewStorage() error
	FreeStorage() error
	CheckStorage() error
}
    MetricStorage представляет интерфейс для работы с хранилищем метрик.

    Он определяет набор методов для сохранения, получения и управления
    метриками. Реализации этого интерфейса могут использовать различные типы
    хранилищ, такие как база данных, файловое хранилище или оперативная память.

    Методы: - Save: Сохраняет одну метрику в хранилище. - SaveAll: Сохраняет
    массив метрик в хранилище. - Get: Получает метрику по её имени. - List:
    Возвращает все метрики в виде мапы, где ключ — имя метрики. - ListSlice:
    Возвращает все метрики в виде слайса. - NewStorage: Инициализирует
    хранилище. - FreeStorage: Освобождает ресурсы, связанные с хранилищем.
    - CheckStorage: Проверяет доступность хранилища.

type MetricsServer struct {
	MetricStorage MetricStorage
	Config        config.ConfigServ
	// Has unexported fields.
}
    MetricsServer представляет сервер для обработки метрик. Он управляет
    хранилищем метрик и предоставляет методы для их сохранения, получения и
    обработки. Поля:
      - MetricStorage: Интерфейс хранилища метрик (база данных, файловое
        хранилище или память). Используется для выполнения операций с метриками.
      - Config: Конфигурация сервера, содержащая параметры подключения и
        настройки.
      - syncMutex: Мьютекс для обеспечения потокобезопасности при работе с
        общими ресурсами.

func NewMetricsServer(Config config.ConfigServ) (*MetricsServer, error)
    NewMetricsServer создает новый экземпляр MetricsServer с выбранным
    хранилищем метрик.

    Выбор хранилища зависит от конфигурации: - Если Config.DBDsn не пустой,
    используется хранилище на основе PostgreSQL (DBStorage). - Если
    Config.FileStoragePath не пустой, используется файловое хранилище
    (FileStorage). - Если ни один из вышеперечисленных параметров не задан,
    используется хранилище в оперативной памяти (MemStorage).

    После выбора хранилища вызывается метод NewStorage для его инициализации.
    Если инициализация завершается ошибкой, она возвращается вызывающей стороне.

    Параметры: - Config: Конфигурация сервера, содержащая параметры для
    подключения к хранилищу.

    Возвращаемые значения: - *MetricsServer: Указатель на созданный экземпляр
    MetricsServer. - error: Ошибка, если произошла проблема при инициализации
    хранилища.

func (ms *MetricsServer) CheckDBConnect(res http.ResponseWriter, req *http.Request)
    CheckDBConnect обрабатывает HTTP-запросы на проверку подключения к базе
    данных.

    Метод проверяет состояние подключения к хранилищу метрик и возвращает
    результат проверки.

    Логика работы:
     1. Проверяется, что метод запроса является GET. Если нет, возвращается
        ошибка 405 (Method Not Allowed).
     2. Вызывается метод CheckStorage хранилища метрик для проверки состояния
        подключения. Если возникает ошибка, возвращается ошибка 500 (Internal
        Server Error) с сообщением "database connection failed".
     3. Если проверка прошла успешно, возвращается HTTP-статус 200 (OK) и текст
        "Status OK".

    Параметры: - res: HTTP-ответ, который будет отправлен клиенту. - req:
    HTTP-запрос, содержащий запрос на проверку подключения к базе данных.

func (ms *MetricsServer) ExtractMetric(res http.ResponseWriter, req *http.Request)
    ExtractMetric обрабатывает HTTP-запросы на получение метрик через JSON.

    Метод принимает метрику в формате JSON, проверяет её корректность, извлекает
    метрику из хранилища и возвращает её в ответе.

    Логика работы:
     1. Проверяется, что метод запроса является POST. Если нет, возвращается
        ошибка 405 (Method Not Allowed).
     2. Тело запроса считывается и десериализуется в объект Metrics. Если данные
        некорректны, возвращается ошибка 404 (Not Found).
     3. Проверяется соответствие типа метрики (MType) между запрошенной и
        полученной из хранилища. Если типы не совпадают, возвращается ошибка
        404.
     4. Метрика извлекается из хранилища по её ID. Если метрика не найдена,
        возвращается ошибка 404.
     5. Обновленная метрика сериализуется в JSON и отправляется в ответе с
        HTTP-статусом 200 (OK).

    Параметры: - res: HTTP-ответ, который будет отправлен клиенту. - req:
    HTTP-запрос, содержащий метрику в формате JSON в теле запроса.

func (ms *MetricsServer) HandleGetAllMetrics(res http.ResponseWriter, req *http.Request)
    HandleGetAllMetrics обрабатывает HTTP-запросы на получение всех метрик в
    виде HTML-страницы.

    Метод извлекает все метрики из хранилища, записывает их в HTML-шаблон и
    возвращает результат клиенту.

    Логика работы:
     1. Проверяется, что метод запроса является GET. Если нет, возвращается
        ошибка 405 (Method Not Allowed).
     2. Загружается HTML-шаблон из файла "cmd/server/static/index.html.tmpl".
        Если шаблон не может быть загружен, возвращается ошибка 500 (Internal
        Server Error).
     3. Все метрики извлекаются из хранилища с помощью метода List. Если
        возникает ошибка при получении метрик, возвращается ошибка 500.
     4. Метрики передаются в HTML-шаблон, который записывается в тело
        HTTP-ответа. Если при записи возникает ошибка, возвращается ошибка 500.
     5. В случае успеха возвращается HTTP-статус 200 (OK) с HTML-страницей.

    Параметры: - res: HTTP-ответ, который будет отправлен клиенту. - req:
    HTTP-запрос, содержащий запрос на получение всех метрик.

func (ms *MetricsServer) HandleGetMetric(res http.ResponseWriter, req *http.Request)
    HandleGetMetric обрабатывает HTTP-запросы на получение значения метрики.

    Метод извлекает тип и имя метрики из параметров запроса, проверяет их
    корректность, и возвращает значение метрики в ответе в текстовом формате
    (text/html).

    Логика работы:
     1. Проверяется, что метод запроса является GET. Если нет, возвращается
        ошибка 405 (Method Not Allowed).
     2. Извлекается тип метрики ("type") из URL-параметров. Если тип пустой,
        возвращается ошибка 404 (Not Found).
     3. Извлекается имя метрики ("name") из URL-параметров и запрашивается
        метрика из хранилища. Если метрика не найдена, возвращается ошибка 404.
     4. В зависимости от типа метрики (gauge или counter) возвращается её
        значение: - Для "gauge" возвращается значение поля Value. - Для
        "counter" возвращается значение поля Delta.
     5. Значение метрики записывается в тело HTTP-ответа в текстовом формате.

    Параметры: - res: HTTP-ответ, который будет отправлен клиенту. - req:
    HTTP-запрос, содержащий параметры пути "type" и "name".

func (ms *MetricsServer) HandlePutCounterMetric(res http.ResponseWriter, req *http.Request)
    HandlePutCounterMetric обрабатывает HTTP-запросы на сохранение метрики типа
    "counter".

    Метод извлекает имя метрики и её значение из параметров запроса, проверяет
    их корректность, и сохраняет метрику в хранилище.

    Логика работы:
     1. Используется мьютекс для обеспечения потокобезопасности при работе с
        хранилищем.
     2. Извлекается имя метрики из параметра пути "name". Если имя пустое,
        возвращается ошибка 404 (Not Found).
     3. Извлекается значение метрики из параметра пути "value" и преобразуется в
        int64. Если значение некорректно, возвращается ошибка 400 (Bad Request).
     4. Создается объект Metrics с типом "counter" и сохраняется в хранилище.
     5. После сохранения выполняется запрос метрики из хранилища для
        подтверждения успешности операции.
     6. В случае успеха возвращается HTTP-статус 200 (OK).

    Параметры: - res: HTTP-ответ, который будет отправлен клиенту. - req:
    HTTP-запрос, содержащий параметры пути "name" и "value".

func (ms *MetricsServer) HandlePutGaugeMetric(res http.ResponseWriter, req *http.Request)
    HandlePutGaugeMetric обрабатывает HTTP-запросы на сохранение метрики типа
    "gauge".

    Метод извлекает имя метрики и её значение из параметров запроса, проверяет
    их корректность, и сохраняет метрику в хранилище.

    Логика работы:
     1. Используется мьютекс для обеспечения потокобезопасности при работе с
        хранилищем.
     2. Извлекается имя метрики из параметра пути "name". Если имя пустое,
        возвращается ошибка 404 (Not Found).
     3. Извлекается значение метрики из параметра пути "value" и преобразуется
        в float64. Если значение некорректно, возвращается ошибка 400 (Bad
        Request).
     4. Создается объект Metrics с типом "gauge" и сохраняется в хранилище.
     5. После сохранения выполняется запрос метрики из хранилища для
        подтверждения успешности операции.
     6. В случае успеха возвращается HTTP-статус 200 (OK).

    Параметры: - res: HTTP-ответ, который будет отправлен клиенту. - req:
    HTTP-запрос, содержащий параметры пути "name" и "value".

func (ms *MetricsServer) IncorrectMetricRq(res http.ResponseWriter, req *http.Request)
    IncorrectMetricRq обрабатывает некорректные запросы на обновление метрик.

    В ответ на запрос отправляется HTTP-ошибка с кодом 400 (Bad Request) и
    сообщением: "Incorrect update metric request!".

func (ms *MetricsServer) NotfoundMetricRq(res http.ResponseWriter, req *http.Request)
    NotfoundMetricRq обрабатывает запросы на получение или обновление
    несуществующих метрик.

    В ответ на запрос отправляется HTTP-ошибка с кодом 404 (Not Found) и
    сообщением: "Metric not found!".

func (ms *MetricsServer) UpdateBatch(res http.ResponseWriter, req *http.Request)
    UpdateBatch обрабатывает HTTP-запросы на пакетное обновление метрик.

    Метод принимает массив метрик в формате JSON, проверяет их корректность,
    сохраняет в хранилище и возвращает обновленный список всех метрик в ответе.

    Логика работы:
     1. Используется мьютекс для обеспечения потокобезопасности при работе с
        хранилищем.
     2. Проверяется, что метод запроса является POST. Если нет, возвращается
        ошибка 405 (Method Not Allowed).
     3. Тело запроса считывается и десериализуется в массив метрик.
        Если данные некорректны или превышают допустимый размер, возвращаются
        соответствующие ошибки: - 413 Request Entity Too Large — если размер
        данных превышает лимит. - 400 Bad Request — если данные некорректны.
     4. Массив метрик сохраняется в хранилище. Если сохранение завершается
        ошибкой, возвращается ошибка 400.
     5. После сохранения извлекается полный список метрик из хранилища.
     6. Список метрик сериализуется в JSON и отправляется в ответе с
        HTTP-статусом 200 (OK).
     7. Если в конфигурации сервера задан ключ (ms.Config.Key), вычисляется хеш
        SHA-256 для ответа и добавляется в заголовок "HashSHA256".

    Параметры: - res: HTTP-ответ, который будет отправлен клиенту. - req:
    HTTP-запрос, содержащий массив метрик в формате JSON в теле запроса.

func (ms *MetricsServer) UpdateMetric(res http.ResponseWriter, req *http.Request)
    UpdateMetric обрабатывает HTTP-запросы на обновление метрик через JSON.

    Метод принимает метрику в формате JSON, проверяет её корректность, сохраняет
    в хранилище и возвращает обновленную метрику в ответе.

    Логика работы:
     1. Используется мьютекс для обеспечения потокобезопасности при работе с
        хранилищем.
     2. Проверяется, что метод запроса является POST. Если нет, возвращается
        ошибка 405 (Method Not Allowed).
     3. Тело запроса считывается и десериализуется в объект Metrics. Если данные
        некорректны, возвращается ошибка 400 (Bad Request).
     4. Метрика сохраняется в хранилище. Если сохранение завершается ошибкой,
        возвращается ошибка 400 (Bad Request).
     5. После сохранения метрика запрашивается из хранилища для подтверждения
        успешности операции.
     6. Обновленная метрика сериализуется в JSON и отправляется в ответе с
        HTTP-статусом 200 (OK).

    Параметры: - res: HTTP-ответ, который будет отправлен клиенту. - req:
    HTTP-запрос, содержащий метрику в формате JSON в теле запроса

